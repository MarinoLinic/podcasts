<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{ page.title }}</title>
		<link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}" />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"
			rel="stylesheet"
		/>
	</head>
	<body>
		<!-- Mobile Menu Button -->
		<button class="menu-toggle" id="menuToggle"><span>‚ò∞</span> Menu</button>

		<!-- Dark Overlay (Mobile) -->
		<div class="overlay" id="overlay"></div>

		<!-- Statistics Modal -->
		<div class="modal-overlay" id="statsOverlay">
			<div class="stats-modal">
				<h3>Note Statistics</h3>
				<div class="stats-grid">
					<!-- 1. Reading Time -->
					<div class="stat-item">
						<span class="stat-label">Reading Time</span>
						<span class="stat-value" id="modal-readtime">0 min</span>
					</div>
					<!-- 2. Word Count -->
					<div class="stat-item">
						<span class="stat-label">Words</span>
						<span class="stat-value" id="modal-words">0</span>
					</div>
					<!-- 3. Character Count -->
					<div class="stat-item">
						<span class="stat-label">Characters</span>
						<span class="stat-value" id="modal-chars">0</span>
					</div>
					<!-- 4. Sentences -->
					<div class="stat-item">
						<span class="stat-label">Sentences</span>
						<span class="stat-value" id="modal-sentences">0</span>
					</div>
					<!-- 5. Lines -->
					<div class="stat-item">
						<span class="stat-label">Lines</span>
						<span class="stat-value" id="modal-lines">0</span>
					</div>
				</div>
				<button
					class="close-modal-btn"
					style="
						margin-top: 20px;
						padding: 8px 16px;
						border: 1px solid #ddd;
						background: #fff;
						cursor: pointer;
						border-radius: 4px;
						font-weight: 500;
					"
				>
					Close
				</button>
			</div>
		</div>

		<!-- Date Modal (New) -->
		<div class="modal-overlay" id="dateOverlay">
			<div class="stats-modal">
				<h3>Publication Timeline</h3>
				<div class="stats-grid">
					<div class="stat-item">
						<span class="stat-label">Published</span>
						<span class="stat-value">{{ page.date | date: "%d %b %Y" }}</span>
					</div>
					<div class="stat-item">
						<span class="stat-label">Time Elapsed</span>
						<span class="stat-value" id="modal-time-ago">Calculating...</span>
					</div>
				</div>
				<button
					class="close-modal-btn"
					style="
						margin-top: 20px;
						padding: 8px 16px;
						border: 1px solid #ddd;
						background: #fff;
						cursor: pointer;
						border-radius: 4px;
						font-weight: 500;
					"
				>
					Close
				</button>
			</div>
		</div>

		<div class="container">
			<!-- Sidebar -->
			<aside class="sidebar" id="sidebar">
				<header>
					<h1><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
					<!-- Permanent Filters -->
					<div class="tag-filter-container">
						<button class="filter-btn" data-filter="politics">Politics</button>
						<button class="filter-btn" data-filter="anthropology">Anthropology</button>
						<button class="filter-btn" data-filter="economics">Economics</button>
						<button class="filter-btn" data-filter="history">History</button>
						<button class="filter-btn" data-filter="life">Life</button>
					</div>
				</header>

				<nav>
					{% assign raw_notes = site.pages | where_exp: "item", "item.path contains 'Notes/'" %} {% assign all_notes =
					raw_notes | where_exp: "item", "item.date" %} {% assign authors = all_notes | map: 'author' | uniq | sort %}
					{% for author in authors %}
					<details open class="author-group">
						<summary>{{ author }}</summary>
						<ul>
							{% assign author_notes = all_notes | where: "author", author %} {% assign top_notes = author_notes |
							where: "rating", 5 | sort: "date" | reverse %} {% assign other_notes = author_notes | where_exp: "item",
							"item.rating != 5" | sort: "date" | reverse %} {% for note in top_notes %}
							<li class="rating-5 note-link-item" data-tags="{{ note.tags | join: ',' | downcase }}">
								<a href="{{ note.url | relative_url }}" class="{% if note.url == page.url %}active{% endif %}"
									>{{ note.title }}</a
								>
							</li>
							{% endfor %} {% for note in other_notes %}
							<li class="rating-{{ note.rating }} note-link-item" data-tags="{{ note.tags | join: ',' | downcase }}">
								<a href="{{ note.url | relative_url }}" class="{% if note.url == page.url %}active{% endif %}"
									>{{ note.title }}</a
								>
							</li>
							{% endfor %}
						</ul>
					</details>
					{% endfor %}
				</nav>

				<div class="sidebar-footer">
					<a href="https://x.com/MarinoLinic" target="_blank" title="Follow on X">
						<svg viewBox="0 0 24 24" aria-hidden="true" class="x-icon">
							<g>
								<path
									d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
								></path>
							</g>
						</svg>
					</a>
				</div>
			</aside>

			<!-- Main Content -->
			<main class="content">
				{% if page.path contains 'Notes/' %}
				<article class="markdown-body" id="note-content">
					<div class="note-header">
						<h1>{{ page.title }}</h1>

						<!-- Metadata Row -->
						<div class="header-meta-row">
							<div class="meta-tags">
								<!-- Clickable Author -->
								<span class="meta-author" id="author-trigger">{{ page.author }}</span>
								<span class="meta-separator">‚Ä¢</span>

								<!-- Clickable Date (Opens Modal) -->
								<span class="meta-date" id="date-trigger" data-date="{{ page.date | date: '%Y-%m-%d' }}"
									>{{ page.date | date: "%d %b %Y" }}</span
								>

								<span class="meta-separator">‚Ä¢</span>
								<span class="meta-stats" id="word-count-trigger"> Loading... </span>

								<!-- TYPE ICON LOGIC -->
								{% if page.type %}
								<span class="meta-separator">‚Ä¢</span>
								<div class="meta-type-wrapper" id="typeIconWrapper">
									<span class="meta-type" title="Type: {{ page.type | capitalize }}">
										{% case page.type %} {% when 'video' %} üé¨ {% when 'article' %} üìÑ {% when 'podcast' %} üéôÔ∏è {% when
										'book' %} üìñ {% else %} üîñ {% endcase %}
									</span>
									<span class="meta-type-label" id="typeLabel">{{ page.type | capitalize }}</span>
								</div>
								{% endif %}
							</div>

							<!-- View Switcher -->
							<div class="view-switcher">
								<button class="view-btn active" id="btn-markdown" onclick="switchView('markdown')">Markdown</button>
								<button class="view-btn" id="btn-text" onclick="switchView('text')">Text</button>
							</div>
						</div>

						<!-- Separate Tags Row -->
						{% if page.tags.size > 0 %}
						<div class="header-tags-row">
							<span class="tags-label">Tags:</span>
							<div class="meta-tag-list">
								{% for tag in page.tags %}
								<span class="meta-tag-item" onclick="filterByTag('{{ tag | downcase }}')">#{{ tag }}</span>
								{% endfor %}
							</div>
						</div>
						{% endif %}
					</div>

					<div id="markdown-view">{{ content }}</div>

					<div id="text-view">
						<div class="copy-btn-wrapper">
							<button class="copy-btn" id="copy-text-btn" onclick="copyToClipboard()"><span>üìã</span> Copy Text</button>
						</div>
						<pre id="raw-text-content">Loading text version...</pre>
					</div>
				</article>

				<section class="transcript-section">
					<details id="transcript-container">
						<summary>üìÑ Read Transcript</summary>
						<div class="transcript-content">
							<pre id="transcript-text">Loading transcript...</pre>
						</div>
					</details>
				</section>

				<!-- Desktop Right Sidebar TOC -->
				<aside class="toc-sidebar" id="desktop-toc">
					<div class="toc-header">On this page</div>
					<ul class="toc-list" id="toc-list-desktop"></ul>
				</aside>

				<!-- Mobile Bottom Bar -->
				<div class="mobile-toc-bar" id="mobile-toc-trigger">
					<span class="mobile-toc-label">Reading:</span>
					<span class="mobile-toc-current" id="mobile-current-header">Introduction</span>
				</div>

				<!-- Mobile Overlay Menu -->
				<div class="toc-backdrop" id="toc-backdrop"></div>
				<div class="toc-mobile-overlay" id="toc-mobile-menu">
					<h3>Table of Contents</h3>
					<ul class="toc-list" id="toc-list-mobile"></ul>
				</div>

				<script>
					document.addEventListener('DOMContentLoaded', function () {
						// --- 1. Sidebar Persistence & Filtering Logic ---
						const authorDetails = document.querySelectorAll('details.author-group')
						const filterBtns = document.querySelectorAll('.filter-btn')
						const noteItems = document.querySelectorAll('.note-link-item')
						let activeTags = new Set(JSON.parse(localStorage.getItem('activeTags')) || [])

						function updateFilterUI() {
							filterBtns.forEach((btn) => {
								const tag = btn.getAttribute('data-filter')
								if (activeTags.has(tag)) btn.classList.add('active')
								else btn.classList.remove('active')
							})
							applyFilters()
						}

						function applyFilters() {
							const showAll = activeTags.size === 0
							if (noteItems.length > 0) {
								noteItems.forEach((item) => {
									if (showAll) {
										item.style.display = ''
										return
									}
									const noteTags = item.getAttribute('data-tags').split(',')
									const hasMatch = noteTags.some((t) => activeTags.has(t))
									item.style.display = hasMatch ? '' : 'none'
								})
								authorDetails.forEach((group) => {
									const visibleChildren = group.querySelectorAll("li:not([style*='display: none'])")
									group.style.display = visibleChildren.length > 0 ? '' : 'none'
								})
							}
						}

						filterBtns.forEach((btn) => {
							btn.addEventListener('click', (e) => {
								const tag = e.target.getAttribute('data-filter')
								if (activeTags.has(tag)) {
									activeTags.delete(tag)
								} else {
									activeTags.add(tag)
								}
								localStorage.setItem('activeTags', JSON.stringify([...activeTags]))
								updateFilterUI()
							})
						})

						window.filterByTag = function (tag) {
							activeTags = new Set([tag])
							localStorage.setItem('activeTags', JSON.stringify([...activeTags]))
							updateFilterUI()
							if (window.innerWidth <= 768) toggleMenu()
							const sb = document.getElementById('sidebar')
							if (sb) sb.scrollTop = 0
						}

						updateFilterUI()

						authorDetails.forEach((details) => {
							const summary = details.querySelector('summary').innerText.trim()
							const storageKey = 'sidebar_author_' + summary
							const savedState = localStorage.getItem(storageKey)
							if (savedState === 'closed' && activeTags.size === 0) details.removeAttribute('open')
							details.addEventListener('toggle', () => {
								localStorage.setItem(storageKey, details.open ? 'open' : 'closed')
							})
						})

						// --- 2. Author Click Logic (Finds First Article of Author) ---
						const authorTrigger = document.getElementById('author-trigger')
						const currentAuthor = '{{ page.author }}'

						if (authorTrigger) {
							authorTrigger.addEventListener('click', () => {
								// Mobile: Open Sidebar
								if (window.innerWidth <= 768) toggleMenu()

								// Find the specific details group for this author
								const summaries = Array.from(document.querySelectorAll('details.author-group summary'))
								const targetSummary = summaries.find((s) => s.innerText.trim() === currentAuthor)

								if (targetSummary) {
									const details = targetSummary.parentElement
									// Open if closed
									if (!details.open) details.open = true

									// Find FIRST link inside
									const firstLink = details.querySelector('ul li a')

									if (firstLink) {
										// Scroll Sidebar to it
										firstLink.scrollIntoView({ behavior: 'smooth', block: 'center' })

										// Flash Highlight
										firstLink.style.transition = 'background 0.3s'
										const oldBg = firstLink.style.backgroundColor
										firstLink.style.backgroundColor = '#fef08a'
										setTimeout(() => {
											firstLink.style.backgroundColor = oldBg
										}, 800)
									}
								}
							})
						}

						// --- 3. Date Modal Logic ---
						const dateTrigger = document.getElementById('date-trigger')
						const dateOverlay = document.getElementById('dateOverlay')
						const timeAgoVal = document.getElementById('modal-time-ago')

						if (dateTrigger && dateOverlay && timeAgoVal) {
							// Pre-calculate
							const dateStr = dateTrigger.getAttribute('data-date')
							const past = new Date(dateStr)
							const now = new Date()
							let months = (now.getFullYear() - past.getFullYear()) * 12
							months -= past.getMonth()
							months += now.getMonth()
							const years = Math.floor(months / 12)
							const remainingMonths = months % 12

							let timeAgoText = ''
							if (years > 0) timeAgoText += years + ' year' + (years > 1 ? 's' : '')
							if (years > 0 && remainingMonths > 0) timeAgoText += ', '
							if (remainingMonths > 0) timeAgoText += remainingMonths + ' month' + (remainingMonths > 1 ? 's' : '')
							if (timeAgoText === '') timeAgoText = 'This month'
							else timeAgoText += ' ago'

							dateTrigger.addEventListener('click', () => {
								timeAgoVal.innerText = timeAgoText
								dateOverlay.style.display = 'flex'
								setTimeout(() => dateOverlay.classList.add('active'), 10)
							})
						}

						// --- 4. Stats & Modal Logic ---
						const contentDiv = document.getElementById('markdown-view')
						const wordTrigger = document.getElementById('word-count-trigger')
						const statsOverlay = document.getElementById('statsOverlay')
						const closeBtns = document.querySelectorAll('.close-modal-btn') // Use class for both buttons

						function safeSetText(id, text) {
							const el = document.getElementById(id)
							if (el) el.innerText = text
						}

						function calculateStats() {
							if (!contentDiv) return { words: 0, chars: 0, lines: 0, readTime: 0, sentences: 0 }
							const text = contentDiv.innerText || ''
							const cleanText = text.trim()
							const words = cleanText.split(/\s+/).filter((w) => w.length > 0).length
							const chars = cleanText.length
							const lines = text.split(/\r\n|\r|\n/).length
							const readTime = Math.ceil(words / 225)
							const sentences = cleanText.split(/[.!?]+/).filter((s) => s.trim().length > 0).length
							return { words, chars, lines, readTime, sentences }
						}

						const stats = calculateStats()
						if (wordTrigger) {
							wordTrigger.innerText = stats.words.toLocaleString() + ' words'
							wordTrigger.addEventListener('click', function () {
								safeSetText('modal-readtime', stats.readTime + ' min')
								safeSetText('modal-words', stats.words.toLocaleString())
								safeSetText('modal-chars', stats.chars.toLocaleString())
								safeSetText('modal-sentences', stats.sentences.toLocaleString())
								safeSetText('modal-lines', stats.lines.toLocaleString())
								if (statsOverlay) {
									statsOverlay.style.display = 'flex'
									setTimeout(() => statsOverlay.classList.add('active'), 10)
								}
							})
						}

						// Shared Modal Close Logic
						function closeModal() {
							const overlays = document.querySelectorAll('.modal-overlay')
							overlays.forEach((ov) => {
								ov.classList.remove('active')
								setTimeout(() => (ov.style.display = 'none'), 200)
							})
						}

						closeBtns.forEach((btn) => btn.addEventListener('click', closeModal))
						document.querySelectorAll('.modal-overlay').forEach((ov) => {
							ov.addEventListener('click', (e) => {
								if (e.target.classList.contains('modal-overlay')) closeModal()
							})
						})

						// --- 5. Type Icon Toggle ---
						const typeWrapper = document.getElementById('typeIconWrapper')
						const typeLabel = document.getElementById('typeLabel')
						if (typeWrapper && typeLabel) {
							typeWrapper.addEventListener('click', function (e) {
								e.stopPropagation()
								typeLabel.classList.toggle('visible')
								setTimeout(() => typeLabel.classList.remove('visible'), 3000)
							})
						}

						// --- 6. View Switcher & Copy ---
						const mdView = document.getElementById('markdown-view')
						const textView = document.getElementById('text-view')
						const btnMd = document.getElementById('btn-markdown')
						const btnText = document.getElementById('btn-text')
						const rawTextContent = document.getElementById('raw-text-content')
						const currentPath = '{{ page.path }}'
						const textFilename = currentPath.split('/').pop().replace('.md', '.txt')
						const textFilePath = "{{ '/Notes_Text/' | relative_url }}" + textFilename
						let textLoaded = false

						window.switchView = function (mode) {
							localStorage.setItem('noteViewMode', mode)
							if (mode === 'text') {
								mdView.style.display = 'none'
								textView.style.display = 'block'
								btnMd.classList.remove('active')
								btnText.classList.add('active')
								if (!textLoaded) {
									fetch(textFilePath)
										.then((res) => res.text())
										.then((text) => {
											rawTextContent.textContent = text
											textLoaded = true
										})
										.catch(() => (rawTextContent.textContent = 'Text version not available.'))
								}
							} else {
								textView.style.display = 'none'
								mdView.style.display = 'block'
								btnText.classList.remove('active')
								btnMd.classList.add('active')
							}
						}
						if (localStorage.getItem('noteViewMode') === 'text') switchView('text')

						window.copyToClipboard = function () {
							navigator.clipboard.writeText(rawTextContent.textContent).then(() => {
								const btn = document.getElementById('copy-text-btn')
								const originalHTML = btn.innerHTML
								btn.innerHTML = '<span>‚úì</span> Copied!'
								btn.classList.add('copied')
								setTimeout(() => {
									btn.innerHTML = originalHTML
									btn.classList.remove('copied')
								}, 2000)
							})
						}

						// --- 7. Transcript & Linkify ---
						const transcriptPath = "{{ '/Transcripts/' | relative_url }}" + transcriptFilename
						const transcriptSection = document.querySelector('.transcript-section')
						fetch(transcriptPath)
							.then((res) => {
								if (!res.ok) throw new Error()
								return res.text()
							})
							.then((text) => (document.getElementById('transcript-text').textContent = text))
							.catch(() => {
								if (transcriptSection) transcriptSection.style.display = 'none'
							})

						if (contentDiv) {
							function linkify(node) {
								if (node.nodeType === 3) {
									const urlRegex = /(https?:\/\/[^\s]+)/g
									const text = node.nodeValue
									if (urlRegex.test(text)) {
										const span = document.createElement('span')
										span.innerHTML = text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>')
										node.parentNode.replaceChild(span, node)
									}
								} else if (node.nodeType === 1 && !['A', 'PRE', 'CODE'].includes(node.tagName)) {
									Array.from(node.childNodes).forEach(linkify)
								}
							}
							linkify(contentDiv)
						}

						// --- 8. Table of Contents & Auto-Scrolling ---
						const markdownBody = document.querySelector('.markdown-body')
						const headers = markdownBody ? markdownBody.querySelectorAll('h1, h2, h3') : []
						const desktopList = document.getElementById('toc-list-desktop')
						const mobileList = document.getElementById('toc-list-mobile')
						const mobileBar = document.getElementById('mobile-toc-trigger')
						const mobileCurrentText = document.getElementById('mobile-current-header')
						const desktopTocSidebar = document.getElementById('desktop-toc')

						if (headers.length > 0) {
							mobileBar.classList.add('visible')

							headers.forEach((header, index) => {
								if (!header.id) header.id = 'section-' + index

								function createTocItem(isMobile) {
									const li = document.createElement('li')
									const a = document.createElement('a')
									a.href = '#' + header.id
									a.innerText = header.innerText
									a.className = 'toc-link'
									// Store ID for easier mapping
									a.setAttribute('data-target', header.id)

									if (header.tagName === 'H1') a.classList.add('level-1')
									if (header.tagName === 'H2') a.classList.add('level-2')
									if (header.tagName === 'H3') a.classList.add('level-3')

									if (isMobile) {
										a.addEventListener('click', () => toggleMobileToc(false))
									}
									li.appendChild(a)
									return li
								}

								desktopList.appendChild(createTocItem(false))
								mobileList.appendChild(createTocItem(true))
							})

							// Active State & Auto-Scrolling
							let currentActiveId = null

							function highlightActiveToc() {
								const scrollPos = window.scrollY
								const triggerPoint = scrollPos + 150
								let currentSection = null

								headers.forEach((header) => {
									if (header.offsetTop <= triggerPoint) {
										currentSection = header
									}
								})

								if (currentSection && currentSection.id !== currentActiveId) {
									currentActiveId = currentSection.id

									// Update Desktop Active Class
									document.querySelectorAll('.toc-link').forEach((link) => {
										link.classList.remove('active')
										if (link.getAttribute('href') === '#' + currentActiveId) {
											link.classList.add('active')

											// Desktop Auto-Scroll
											// Only scroll sidebar if it's the desktop list link
											if (!link.closest('#toc-list-mobile')) {
												link.scrollIntoView({ behavior: 'smooth', block: 'center' })
											}
										}
									})
									// Update Mobile Text
									mobileCurrentText.innerText = currentSection.innerText
								}
							}

							window.addEventListener('scroll', highlightActiveToc)
							highlightActiveToc()
						}

						// Mobile TOC Toggle Logic
						const tocBackdrop = document.getElementById('toc-backdrop')
						const tocMenu = document.getElementById('toc-mobile-menu')

						function toggleMobileToc(show) {
							if (show) {
								tocBackdrop.classList.add('active')
								tocMenu.classList.add('active')

								// Scroll Mobile Menu to Active Link immediately
								const activeMobileLink = mobileList.querySelector('.toc-link.active')
								if (activeMobileLink) {
									setTimeout(() => {
										activeMobileLink.scrollIntoView({ behavior: 'smooth', block: 'center' })
									}, 100)
								}
							} else {
								tocBackdrop.classList.remove('active')
								tocMenu.classList.remove('active')
							}
						}

						if (mobileBar) mobileBar.addEventListener('click', () => toggleMobileToc(true))
						if (tocBackdrop) tocBackdrop.addEventListener('click', () => toggleMobileToc(false))
					})
				</script>
				{% else %}
				<div class="markdown-body">{{ content }}</div>
				{% endif %}
			</main>
		</div>

		<script>
			// Global Menu Logic
			const sidebar = document.querySelector('.sidebar')
			const scrollKey = 'sidebarScrollPos'
			const savedScroll = localStorage.getItem(scrollKey)
			if (savedScroll && sidebar) sidebar.scrollTop = savedScroll
			window.addEventListener('beforeunload', () => {
				if (sidebar) localStorage.setItem(scrollKey, sidebar.scrollTop)
			})
			const menuBtn = document.getElementById('menuToggle')
			const overlay = document.getElementById('overlay')
			const sidebarEl = document.getElementById('sidebar')
			const sidebarLinks = document.querySelectorAll('.sidebar nav a')
			function toggleMenu() {
				sidebarEl.classList.toggle('open')
				overlay.classList.toggle('active')
				menuBtn.innerHTML = sidebarEl.classList.contains('open') ? '<span>‚úï</span> Close' : '<span>‚ò∞</span> Menu'
			}
			if (menuBtn) {
				menuBtn.addEventListener('click', toggleMenu)
				overlay.addEventListener('click', toggleMenu)
			}
			sidebarLinks.forEach((link) => {
				link.addEventListener('click', () => {
					if (window.innerWidth <= 768) toggleMenu()
				})
			})
			if (sidebarEl.classList.contains('open')) menuBtn.innerHTML = '<span>‚úï</span> Close'
		</script>
	</body>
</html>
