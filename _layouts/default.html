<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{ page.title }}</title>
		<link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}" />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"
			rel="stylesheet"
		/>
	</head>
	<body>
		<!-- Mobile Menu Button -->
		<button class="menu-toggle" id="menuToggle"><span>â˜°</span> Menu</button>

		<!-- Dark Overlay (Mobile) -->
		<div class="overlay {% if page.url == '/' %}active{% endif %}" id="overlay"></div>

		<!-- NEW: Statistics Modal -->
		<div class="modal-overlay" id="statsOverlay">
			<div class="stats-modal">
				<h3>Note Statistics</h3>
				<div class="stats-grid">
					<div class="stat-item">
						<span class="stat-label">Words</span>
						<span class="stat-value" id="modal-words">0</span>
					</div>
					<div class="stat-item">
						<span class="stat-label">Characters</span>
						<span class="stat-value" id="modal-chars">0</span>
					</div>
					<div class="stat-item">
						<span class="stat-label">Lines</span>
						<span class="stat-value" id="modal-lines">0</span>
					</div>
				</div>
				<button
					onclick="closeStats()"
					style="
						margin-top: 20px;
						padding: 8px 16px;
						border: 1px solid #ddd;
						background: #fff;
						cursor: pointer;
						border-radius: 4px;
						font-weight: 500;
					"
				>
					Close
				</button>
			</div>
		</div>

		<div class="container">
			<!-- Sidebar -->
			<aside class="sidebar {% if page.url == '/' %}open{% endif %}" id="sidebar">
				<header>
					<h1><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
					<p class="subtitle">Archive</p>
				</header>
				<nav>
					<!-- 1. Filter out notes that are missing a date to prevent build crash -->
					{% assign raw_notes = site.pages | where_exp: "item", "item.path contains 'Notes/'" %} {% assign all_notes =
					raw_notes | where_exp: "item", "item.date" %}

					<!-- 2. Extract Authors -->
					{% assign authors = all_notes | map: 'author' | uniq | sort %} {% for author in authors %}
					<!-- 'open' attribute is default, JS will close it if saved in localStorage -->
					<details open class="author-group">
						<summary>{{ author }}</summary>
						<ul>
							{% assign author_notes = all_notes | where: "author", author %}

							<!-- 3. Sort Logic -->
							{% assign top_notes = author_notes | where: "rating", 5 | sort: "date" | reverse %} {% assign other_notes
							= author_notes | where_exp: "item", "item.rating != 5" | sort: "date" | reverse %} {% for note in
							top_notes %}
							<li class="rating-5">
								<a href="{{ note.url | relative_url }}" class="{% if note.url == page.url %}active{% endif %}"
									>{{ note.title }}</a
								>
							</li>
							{% endfor %} {% for note in other_notes %}
							<li class="rating-{{ note.rating }}">
								<a href="{{ note.url | relative_url }}" class="{% if note.url == page.url %}active{% endif %}"
									>{{ note.title }}</a
								>
							</li>
							{% endfor %}
						</ul>
					</details>
					{% endfor %}
				</nav>
			</aside>

			<!-- Main Content -->
			<main class="content">
				{% if page.path contains 'Notes/' %}
				<article class="markdown-body" id="note-content">
					<div class="note-header">
						<h1>{{ page.title }}</h1>

						<div class="header-meta-row">
							<div class="meta-tags">
								<span class="meta-author">{{ page.author }}</span>
								<span class="meta-separator">â€¢</span>
								<span class="meta-date">{{ page.date | date: "%d %b %Y" }}</span>
								<span class="meta-separator">â€¢</span>
								<!-- UPDATED: Word Count Trigger -->
								<span class="meta-stats" id="word-count-trigger" onclick="openStats()"> Loading... </span>
							</div>

							<!-- View Switcher -->
							<div class="view-switcher">
								<button class="view-btn active" id="btn-markdown" onclick="switchView('markdown')">Markdown</button>
								<button class="view-btn" id="btn-text" onclick="switchView('text')">Text</button>
							</div>
						</div>
					</div>

					<!-- View Containers -->
					<div id="markdown-view">{{ content }}</div>

					<!-- Text View with Copy Button -->
					<div id="text-view">
						<div class="copy-btn-wrapper">
							<button class="copy-btn" id="copy-text-btn" onclick="copyToClipboard()"><span>ðŸ“‹</span> Copy Text</button>
						</div>
						<pre id="raw-text-content">Loading text version...</pre>
					</div>
				</article>

				<!-- Transcript Section -->
				<section class="transcript-section">
					<details id="transcript-container">
						<summary>ðŸ“„ Read Transcript</summary>
						<div class="transcript-content">
							<pre id="transcript-text">Loading transcript...</pre>
						</div>
					</details>
				</section>

				<!-- Note Specific Scripts -->
				<script>
					document.addEventListener('DOMContentLoaded', function () {
						// --- 1. Sidebar Persistence Logic ---
						const authorDetails = document.querySelectorAll('details.author-group')

						authorDetails.forEach((details) => {
							const summary = details.querySelector('summary').innerText.trim()
							// Create a unique key for each author
							const storageKey = 'sidebar_author_' + summary

							// Check LocalStorage
							const savedState = localStorage.getItem(storageKey)

							// The HTML defaults to 'open'. If storage says 'closed', we remove the attribute.
							if (savedState === 'closed') {
								details.removeAttribute('open')
							}

							// Listen for toggles and save state
							details.addEventListener('toggle', () => {
								if (details.open) {
									localStorage.setItem(storageKey, 'open')
								} else {
									localStorage.setItem(storageKey, 'closed')
								}
							})
						})

						// --- 2. Word Count & Stats Logic ---
						const contentDiv = document.getElementById('markdown-view')
						const trigger = document.getElementById('word-count-trigger')

						function calculateStats() {
							if (!contentDiv) return { words: 0, chars: 0, lines: 0 }

							// Get text content (stripped of HTML tags for accuracy)
							const text = contentDiv.innerText || ''

							const words = text
								.trim()
								.split(/\s+/)
								.filter((w) => w.length > 0).length
							const chars = text.length
							// Rough line count estimate
							const lines = text.split(/\r\n|\r|\n/).length

							return { words, chars, lines }
						}

						// Initialize Stats on Load
						const stats = calculateStats()
						if (trigger) trigger.innerText = stats.words.toLocaleString() + ' words'

						// Modal Functions
						window.openStats = function () {
							document.getElementById('modal-words').innerText = stats.words.toLocaleString()
							document.getElementById('modal-chars').innerText = stats.chars.toLocaleString()
							document.getElementById('modal-lines').innerText = stats.lines.toLocaleString()

							const overlay = document.getElementById('statsOverlay')
							overlay.style.display = 'flex'
							// Small timeout to allow display:flex to apply before opacity transition
							setTimeout(() => overlay.classList.add('active'), 10)
						}

						window.closeStats = function () {
							const overlay = document.getElementById('statsOverlay')
							overlay.classList.remove('active')
							// Wait for transition to finish before hiding
							setTimeout(() => (overlay.style.display = 'none'), 200)
						}

						// Close modal on background click
						document.getElementById('statsOverlay').addEventListener('click', (e) => {
							if (e.target.id === 'statsOverlay') closeStats()
						})

						// --- 3. View Switcher Logic ---
						const mdView = document.getElementById('markdown-view')
						const textView = document.getElementById('text-view')
						const btnMd = document.getElementById('btn-markdown')
						const btnText = document.getElementById('btn-text')
						const rawTextContent = document.getElementById('raw-text-content')

						const currentPath = '{{ page.path }}'
						const textFilename = currentPath.split('/').pop().replace('.md', '.txt')
						const textFilePath = "{{ '/Notes_Text/' | relative_url }}" + textFilename
						let textLoaded = false

						window.switchView = function (mode) {
							localStorage.setItem('noteViewMode', mode)

							if (mode === 'text') {
								mdView.style.display = 'none'
								textView.style.display = 'block'
								btnMd.classList.remove('active')
								btnText.classList.add('active')

								if (!textLoaded) {
									fetch(textFilePath)
										.then((res) => res.text())
										.then((text) => {
											rawTextContent.textContent = text
											textLoaded = true
										})
										.catch((err) => (rawTextContent.textContent = 'Text version not available.'))
								}
							} else {
								textView.style.display = 'none'
								mdView.style.display = 'block'
								btnText.classList.remove('active')
								btnMd.classList.add('active')
							}
						}

						// Restore Preference
						const savedMode = localStorage.getItem('noteViewMode')
						if (savedMode === 'text') {
							switchView('text')
						}

						// --- 4. Copy to Clipboard Function ---
						window.copyToClipboard = function () {
							const text = rawTextContent.textContent
							const btn = document.getElementById('copy-text-btn')

							navigator.clipboard
								.writeText(text)
								.then(() => {
									// Visual Feedback
									const originalHTML = btn.innerHTML
									btn.innerHTML = '<span>âœ“</span> Copied!'
									btn.classList.add('copied')

									setTimeout(() => {
										btn.innerHTML = originalHTML
										btn.classList.remove('copied')
									}, 2000)
								})
								.catch((err) => {
									console.error('Failed to copy: ', err)
								})
						}

						// --- 5. Transcript Logic ---
						const transcriptFilename = currentPath.split('/').pop().replace('.md', '.txt')
						const transcriptPath = "{{ '/Transcripts/' | relative_url }}" + transcriptFilename
						const transcriptSection = document.querySelector('.transcript-section')

						fetch(transcriptPath)
							.then((res) => {
								if (!res.ok) throw new Error('Not found')
								return res.text()
							})
							.then((text) => (document.getElementById('transcript-text').textContent = text))
							.catch((err) => {
								if (transcriptSection) transcriptSection.style.display = 'none'
							})

						// --- 6. Linkifier ---
						if (contentDiv) {
							function linkify(node) {
								if (node.nodeType === 3) {
									const urlRegex = /(https?:\/\/[^\s]+)/g
									const text = node.nodeValue
									if (urlRegex.test(text)) {
										const span = document.createElement('span')
										span.innerHTML = text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>')
										node.parentNode.replaceChild(span, node)
									}
								} else if (
									node.nodeType === 1 &&
									node.tagName !== 'A' &&
									node.tagName !== 'PRE' &&
									node.tagName !== 'CODE'
								) {
									Array.from(node.childNodes).forEach(linkify)
								}
							}
							linkify(contentDiv)
						}
					})
				</script>
				{% else %}
				<!-- This else block handles pages that aren't notes (like index.html) -->
				<div class="markdown-body">{{ content }}</div>
				{% endif %}
			</main>
		</div>

		<!-- GLOBAL SCRIPTS (Mobile Menu & Scroll Position) -->
		<script>
			const sidebar = document.querySelector('.sidebar')
			const scrollKey = 'sidebarScrollPos'
			const savedScroll = localStorage.getItem(scrollKey)
			if (savedScroll && sidebar) sidebar.scrollTop = savedScroll

			window.addEventListener('beforeunload', () => {
				if (sidebar) localStorage.setItem(scrollKey, sidebar.scrollTop)
			})

			const menuBtn = document.getElementById('menuToggle')
			const overlay = document.getElementById('overlay')
			const sidebarEl = document.getElementById('sidebar')
			const sidebarLinks = document.querySelectorAll('.sidebar nav a')

			function toggleMenu() {
				sidebarEl.classList.toggle('open')
				overlay.classList.toggle('active')
				if (sidebarEl.classList.contains('open')) {
					menuBtn.innerHTML = '<span>âœ•</span> Close'
				} else {
					menuBtn.innerHTML = '<span>â˜°</span> Menu'
				}
			}

			if (menuBtn) {
				menuBtn.addEventListener('click', toggleMenu)
				overlay.addEventListener('click', toggleMenu)
			}

			sidebarLinks.forEach((link) => {
				link.addEventListener('click', () => {
					if (window.innerWidth <= 768) toggleMenu()
				})
			})

			if (sidebarEl.classList.contains('open')) {
				menuBtn.innerHTML = '<span>âœ•</span> Close'
			}
		</script>
	</body>
</html>
